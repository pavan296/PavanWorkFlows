name: Daily README Update (Reusable)

on:
  workflow_call:
    inputs:
      timezone:
        description: 'Timezone for date display (e.g., Asia/Dubai, America/New_York)'
        required: false
        type: string
        default: 'UTC'
      readme_template:
        description: 'Custom README template type (default, minimal, detailed)'
        required: false
        type: string
        default: 'default'
      quote_category:
        description: 'Quote category (inspirational, motivational, wisdom, success)'
        required: false
        type: string
        default: ''
      enable_stats:
        description: 'Enable repository statistics in README'
        required: false
        type: boolean
        default: true
    secrets:
      token:
        description: 'GitHub token for committing'
        required: false

jobs:
  update-readme:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.token || secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # For better git history access
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          pip install --no-cache-dir requests pytz
      
      - name: Update README
        env:
          TIMEZONE: ${{ inputs.timezone }}
          TEMPLATE: ${{ inputs.readme_template }}
          QUOTE_CATEGORY: ${{ inputs.quote_category }}
          ENABLE_STATS: ${{ inputs.enable_stats }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python << 'EOF'
          import requests
          import datetime
          import pytz
          import os
          import json
          from urllib.parse import quote as url_quote
          
          def fetch_quote_with_fallback(category=""):
              """Fetch quote with multiple API fallbacks and local fallbacks."""
              fallback_quotes = [
                  {"content": "The only way to do great work is to love what you do.", "author": "Steve Jobs"},
                  {"content": "Innovation distinguishes between a leader and a follower.", "author": "Steve Jobs"},
                  {"content": "Stay hungry, stay foolish.", "author": "Steve Jobs"},
                  {"content": "Code is poetry.", "author": "Anonymous"},
                  {"content": "First, solve the problem. Then, write the code.", "author": "John Johnson"}
              ]
              
              # Try primary API with category if specified
              apis = []
              if category:
                  apis.append(f'https://api.quotable.io/random?tags={url_quote(category)}')
              apis.extend([
                  'https://api.quotable.io/random',
                  'https://zenquotes.io/api/random',
                  'https://api.adviceslip.com/advice'
              ])
              
              for api_url in apis:
                  try:
                      response = requests.get(api_url, timeout=8)
                      if response.status_code == 200:
                          data = response.json()
                          
                          # Handle different API response formats
                          if 'content' in data and 'author' in data:  # quotable.io
                              return data['content'], data['author']
                          elif isinstance(data, list) and len(data) > 0:  # zenquotes.io
                              quote_data = data[0]
                              return quote_data.get('q', ''), quote_data.get('a', 'Unknown')
                          elif 'slip' in data and 'advice' in data['slip']:  # adviceslip.com
                              return data['slip']['advice'], 'Advice Slip'
                              
                  except Exception as e:
                      print(f"API {api_url} failed: {e}")
                      continue
              
              # Use fallback quote if all APIs fail
              import random
              fallback = random.choice(fallback_quotes)
              return fallback['content'], fallback['author']
          
          def get_repository_stats():
              """Get repository statistics if enabled."""
              enable_stats = os.environ.get('ENABLE_STATS', 'true').lower() == 'true'
              if not enable_stats:
                  return ""
              
              repo_name = os.environ.get('GITHUB_REPOSITORY', 'repository')
              
              return f"""
## üìä Repository Stats

- **Repository:** {repo_name}
- **Workflow:** Daily README Update
- **Last Execution:** Just now ‚ö°"""
          
          # Get inputs from environment
          timezone_str = os.environ.get('TIMEZONE', 'UTC')
          template_type = os.environ.get('TEMPLATE', 'default')
          quote_category = os.environ.get('QUOTE_CATEGORY', '')
          
          # Fetch quote
          print("Fetching inspirational quote...")
          quote, author = fetch_quote_with_fallback(quote_category)
          print(f"Quote retrieved: {quote[:50]}..." if len(quote) > 50 else quote)
          
          # Get current date with timezone
          try:
              tz = pytz.timezone(timezone_str)
              now = datetime.datetime.now(tz)
              today = now.strftime('%B %d, %Y')
              time_str = now.strftime('%I:%M %p %Z')
              week_day = now.strftime('%A')
          except Exception as e:
              print(f"Timezone error: {e}, using UTC")
              now = datetime.datetime.now(pytz.UTC)
              today = now.strftime('%B %d, %Y')
              time_str = now.strftime('%I:%M %p UTC')
              week_day = now.strftime('%A')
          
          # Generate stats section
          stats_section = get_repository_stats()
          
          # Generate README based on template type
          templates = {
              'minimal': f"""# üìÖ Daily Updates

**Last Updated:** {today} at {time_str}

> *"{quote}"*  
> **‚Äî {author}**{stats_section}
""",
              'detailed': f"""# üìä Daily Updates Repository

## üìÖ Last Updated
- **Date:** {today}  
- **Time:** {time_str}  
- **Day:** {week_day}

## üí≠ Quote of the Day

> *"{quote}"*
> 
> **‚Äî {author}**

---
{stats_section}

## üìà Calendar Info

- **Days This Year:** {now.timetuple().tm_yday} of 365
- **Current Month:** {now.strftime('%B')}
- **Week of Year:** Week {now.isocalendar()[1]}
- **Season:** {['Winter', 'Winter', 'Spring', 'Spring', 'Spring', 'Summer', 'Summer', 'Summer', 'Fall', 'Fall', 'Fall', 'Winter'][now.month-1]}

---

## ‚ÑπÔ∏è About

This repository automatically updates daily with inspirational content using GitHub Actions.

**Status:** ‚úÖ Active | **Frequency:** Daily | **Automation:** GitHub Actions
""",
              'default': f"""# üìÖ Daily Updates Repository

## Last Updated: {today}

## üí≠ Quote of the Day

> *"{quote}"*
> 
> **‚Äî {author}**

---
{stats_section}

### ü§ñ About This Repository

This repository is automatically updated daily with inspirational quotes and fresh timestamps.

**Status:** ‚úÖ Active | **Last Run:** {today} at {time_str}

---
*Powered by GitHub Actions* üöÄ
"""
          }
          
          readme_content = templates.get(template_type, templates['default'])
          
          # Write to README.md with error handling
          try:
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(readme_content)
              print("‚úÖ README updated successfully!")
              print(f"üìÖ Date: {today}")
              print(f"üí≠ Quote: {quote[:100]}{'...' if len(quote) > 100 else ''}")
              print(f"üë§ Author: {author}")
          except Exception as e:
              print(f"‚ùå Error writing README: {e}")
              exit(1)
          EOF
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "üìã No changes detected in README.md"
            exit 0
          fi
          
          # Create commit with enhanced message
          COMMIT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "üìÖ Daily README update: $COMMIT_DATE

          ü§ñ Automated daily content refresh
          üìù Updated quotes and timestamps
          ‚è∞ Timezone: ${{ inputs.timezone }}
          üìã Template: ${{ inputs.readme_template }}"
          
          # Push changes with retry logic
          for i in {1..3}; do
            if git push; then
              echo "‚úÖ Changes pushed successfully on attempt $i"
              break
            else
              echo "‚ö†Ô∏è  Push attempt $i failed, retrying in 5 seconds..."
              sleep 5
            fi
            
            if [ $i -eq 3 ]; then
              echo "‚ùå Failed to push after 3 attempts"
              exit 1
            fi
          done
